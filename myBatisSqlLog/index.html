<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mybatis Sql Log Parser</title>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/sql-formatter/11.0.2/sql-formatter.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }

        h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        textarea {
            width: 100%;
            min-height: 150px;
            border: 2px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            margin-bottom: 10px;
            resize: none; /* 禁止手动调整大小 */
            overflow: auto; /* 自动滚动条 */
        }

        .btn_contain {
            text-align: center;
            margin-top: 20px;
        }

        .btn {
            width: 200px;
            margin: 10px;
            height: 40px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .m-toast-pop {
            display: none;
            position: fixed;
            width: 100%;
            top: 0;
            bottom: 0;
            right: 0;
            overflow: auto;
            text-align: center;
        }

        .m-toast-inner {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 100%;
            transform: translate(-50%, -50%);
            -webkit-transform: translate(-50%, -50%);
            text-align: center;
        }

        .m-toast-inner-text {
            display: inline-block;
            margin: 0 22px;
            padding: 19px 21px;
            font-size: 16px;
            color: #FFFFFF;
            letter-spacing: 0;
            line-height: 22px;
            background: rgba(0, 0, 0, 0.72);
            border-radius: 10px;
        }
    </style>

    <script type="text/javascript">
        function $(id) {
            return document.getElementById(id);
        }

        function parsePara(p) {
            if (p == "null") {
                return p;
            }
            var result;
            var m = p.match(/\(([^\)]+)\)$/)[1];
            result = p.replace(`(` + m + `)`, "")
            switch (m) {
                case "String":
                case "Timestamp":
                    result = "'" + result + "'";
                    break;
                case "Integer":
                    break;
                case "Date":
                    result = "STR_TO_DATE('" + result + "','%Y-%m-%d %H:%i:%s')";
                    break;
                default:
                    break;
            }
            return result;
        }

        function parseParas(para) {
            var ps = [];
            var p;
            var result = para.replace(/.*(Parameters[\s]*(?=:)):/, "");
            var t = result.match(/(.+?\(*.+?\)*(?=[\s]*\,))|(.+?\(.+?\)$)/g);
            var len = t.length;
            if (len > 0) {
                for (var i = 0; i < len; i++) {
                    p = t[i].replace(/,$/, "").replace(/^[\,]/, "").replace(/^[\s]*||[\s]*$/, "");
                    ps.push(parsePara(p));
                }
            }
            return ps;
        }

        function parseSql(sql) {
            var result = sql.replace(/.*(Preparing[\s]*(?=:)):/, "");
            return result;
        }

        function getRealSql(paraMeter, sqlOrg) {
            try {
                var realSql = parseSql(paraMeter);
                var realParas = parseParas(sqlOrg);
            } catch (error) {
                alert('参数转换错误！');
                throw error;
            }
            var len = realParas.length;
            for (var i = 0; i < len; i++) {
                realSql = realSql.replace("?", realParas[i]);
            }
            return realSql;
        }

        function format() {
            if (event.keyCode == '13') {
                var sql = $("sql").value;
                var para = $("para").value;
                var fomatSql = getRealSql(sql, para);
                $("result").value = fomatSql;
            }
        }

        function converSql() {
            var sql = $("sql").value;
            var para = $("para").value;
            var fomatSql = getRealSql(sql, para);
            try {
                fomatSql = getFormatSql(fomatSql, "sql");
            } catch (e) {
                console.error("SQL美化出错", e);
            }
            $("result").value = fomatSql;
        }

        function reset() {
            var sql = $("sql").value = "";
            var para = $("para").value = "";
            $("result").value = "";
        }

        function copyRes() {
            var copycode = $("result");
            copycode.select();
            document.execCommand("Copy");
        }

        function getFormatSql(editorValue, sqlType) {
            return sqlFormatter.format(editorValue, {
                language: sqlType
            });
        }

        function selfMinify() {
            var editorValue = inputACEEditor[_0x485405(0x23b)]();
            var newValue = editorValue.split("\n").join(" ").replace(/\s+/g, " ");
            outputACEEditor['setValue'](newValue, 0x1);
        }

        function selfBeautifySQL() {
            var editorValue = inputACEEditor[_0x485405(0x23b)]();
            var newValue = getFormatSql(editorValue, 'sql');
            outputACEEditor['setValue'](newValue, 0x1);
        }

        function getSQLSampleData() {
            inputACEEditor['setValue']('select * from tb where id=123', 0x1);
        }

        function displayCenterMessage(a, b) {
            if (a == 'Copied to Clipboard') {
                a = '复制成功√';
            }
            if (b == 'success') {
                Alert.alertSimple(a);
            } else {
                Alert.alertSimpleError(a);
            }
        }

        // 自适应高度
        function autoResizeTextarea(textareaId) {
            const textarea = $(textareaId);
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        // 监听输入事件
        document.addEventListener('DOMContentLoaded', () => {
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', () => autoResizeTextarea(textarea.id));
            });
        });
    </script>
</head>

<body>
    <div class="container">
        <h2>输入SQL log日志 <button class="btn" onclick="reset();">重置</button></h2>
        <textarea id="sql" onkeydown="format()" oninput="autoResizeTextarea(this.id)"></textarea>

        <h2>输入SQL参数 <button class="btn" onclick="converSql();">转换</button></h2>
        <textarea id="para" oninput="autoResizeTextarea(this.id)"></textarea>

        <h2>转换结果 <button class="btn" onclick="copyRes();">复制结果</button></h2>
        <textarea id="result" oninput="autoResizeTextarea(this.id)"></textarea>
    </div>
</body>
</html>
